<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线抽奖工具</title>
    <!-- 预加载关键资源 -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style">
    
    <!-- 加载样式表 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <link rel="stylesheet" href="styles.css">
    
    <!-- 预加载Excel处理库 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="text-center my-5">
            <h1 class="display-4">在线抽奖工具</h1>
            <p class="lead">上传名单，设置中奖人数，开始抽奖！</p>
        </header>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-lg mb-5">
                    <div class="card-body p-5">
                        <div class="mb-4">
                            <h5 class="card-title mb-3">第一步：上传参与者名单</h5>
                            <div class="file-upload-wrapper">
                                <label for="fileUpload" class="form-label">支持 .xlsx 和 .csv 格式文件</label>
                                <div class="d-flex align-items-center mb-2">
                                    <button id="downloadExcel" class="btn btn-sm btn-outline-primary me-2">下载Excel模板</button>
                                    <a href="templates/新版抽奖名单模板.csv" download="抽奖名单模板.csv" class="btn btn-sm btn-outline-primary">下载CSV模板</a>
                                </div>
                                <input class="form-control" type="file" id="fileUpload" accept=".xlsx,.csv">
                            </div>
                            <div id="fileInfo" class="mt-2 small text-muted"></div>
                        </div>

                        <div class="mb-4">
                            <h5 class="card-title mb-3">第二步：设置中奖人数</h5>
                            <div class="input-group">
                                <input type="number" class="form-control" id="winnerCount" min="1" value="1">
                                <span class="input-group-text">人</span>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button id="drawBtn" class="btn btn-primary btn-lg px-5" disabled>开始抽奖</button>
                            <button id="reuploadBtn" class="btn btn-outline-secondary btn-lg px-5 ms-2" disabled>重新上传文件</button>
                        </div>
                    </div>
                </div>

                <div id="resultSection" class="card shadow-lg mb-5 d-none">
                    <div class="card-body p-5">
                        <h5 class="card-title text-center mb-4">中奖结果</h5>
                        <div id="winnerDisplay" class="winner-display"></div>
                        <div id="winnerHistory" class="mt-4">
                            <h6>历史中奖记录</h6>
                            <ul class="list-group" id="historyList"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-light">抽奖中...</p>
    </div>

    <!-- 引入必要的脚本和样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- 异步加载非关键脚本 -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>
    
    <!-- 主脚本放在前面确保优先加载 -->
    <script src="script.js"></script>
    
    <!-- Excel模板生成脚本 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取下载Excel按钮元素
        const downloadExcelBtn = document.getElementById('downloadExcel');
        
        // 添加点击事件监听器
        downloadExcelBtn.addEventListener('click', function() {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建数据
            const data = [
                ['姓名', '部门'],
                ['张三', '市场部'],
                ['李四', '技术部'],
                ['王五', '行政部']
            ];
            
            // 将数据转换为worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // 设置列宽
            ws['!cols'] = [
                { wch: 15 }, // 姓名列宽
                { wch: 20 }  // 部门列宽
            ];
            
            // 将worksheet添加到工作簿
            XLSX.utils.book_append_sheet(wb, ws, "抽奖名单");
            
            // 写入文件并下载
            XLSX.writeFile(wb, "抽奖名单模板.xlsx");
        });
    });
    </script>
    
    <!-- 广告脚本放在最后 -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9417007470661940" crossorigin="anonymous"></script>

    <!-- 添加文件大小限制 -->
    <script>
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // 检查文件大小
        if (file.size > MAX_FILE_SIZE) {
            alert('文件大小超过限制（最大5MB）');
            return;
        }
        
        // 使用Web Worker处理大文件
        if (file.size > 1 * 1024 * 1024) { // 大于1MB的文件使用Web Worker
            processLargeFile(file);
        } else {
            processSmallFile(file);
        }
    }
    </script>

    <!-- 减少动画使用 -->
    <script>
    function displayWinners(newWinners) {
        winnerDisplay.innerHTML = '';
        newWinners.forEach((winner, index) => {
            const winnerCard = document.createElement('div');
            winnerCard.className = 'winner-card';
            // 只在第一个中奖者显示动画
            if (index === 0) {
                winnerCard.classList.add('animate__animated', 'animate__bounceIn');
            }
            winnerCard.textContent = winner;
            winnerDisplay.appendChild(winnerCard);
        });
    }
    </script>

    <!-- 添加资源预加载 -->
    <script>
    const preloadResources = () => {
        const resources = [
            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css',
            'https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css'
        ];
        
        resources.forEach(url => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.href = url;
            link.as = 'style';
            document.head.appendChild(link);
        });
    };

    // 在页面加载时调用
    document.addEventListener('DOMContentLoaded', preloadResources);
    </script>

    <!-- 添加超时处理 -->
    <script>
    const TIMEOUT = 10000; // 10秒超时

    function processFile(file) {
        return new Promise((resolve, reject) => {
            const timeoutId = setTimeout(() => {
                reject(new Error('文件处理超时'));
            }, TIMEOUT);
            
            // 文件处理逻辑...
            
            clearTimeout(timeoutId);
            resolve(result);
        });
    }
    </script>
</body>
</html>